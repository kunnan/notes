**Java虚拟机运行时数据区域**

[TOC]

# Java虚拟机结构

![Java虚拟机结构](http://upload-images.jianshu.io/upload_images/1417629-3a2a7c7286d0418a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# 运行时数据区域

Java 虚拟机运行时数据区域包括以下5个部分：

* 程序计数器（Program Counter Register）
* Java虚拟机栈（VM Stack）
* 本地方法栈（Native Method Stack）
* Java堆（Java Heap）
* 方法区（Method area）

## 程序计数器

程序计数器，也叫PC寄存器，是一块较小的内存空间，可以看作是当前线程执行的字节码的行号指示器。在虚拟机的概念模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令。

在任何一个确定的时刻，一个处理器都只会执行一条线程中的指令。为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，因此，程序计数器是线程私有的。

如果线程执行的是一个 Java 方法，这个计数器记录的是正在执行的虚拟机字节码指令的地址；如果执行的是 Native 方法，这个计数器值则为空（Undefined）。程序计数器是Java 虚拟机规范中唯一没有规定任何 OutOfMemoryError 情况的区域。

## Java 虚拟机栈

Java 虚拟机栈也是线程私有的，它的生命周期和线程相同。

Java虚拟机栈存储线程中**Java方法调用的状态**，包括局部变量、参数、返回值以及运算的中间结果等。一个Java虚拟机栈包含了多个栈帧，一个栈帧用来存储局部变量表、操作数栈、动态链接、方法出口等信息。**当线程调用一个Java方法时**，虚拟机压入一个新的栈帧到该线程的Java栈中，当该方法执行完成，这个栈帧就从Java栈中弹出。我们平常所说的栈内存（Stack）指的就是Java虚拟机栈。

Java虚拟机规范中定义了两种异常情况：

* 如果线程请求的栈深度大于虚拟机所允许的深度，将抛出StackOverflowError异常；
* 如果Java虚拟机可以动态扩展（大部分Java虚拟机都可以动态扩展），如果扩展时无法申请到足够的内存，或者说创建新的线程时没有足够的内存去创建对应的 Java 虚拟机栈，则会抛出 OutOfMemoryError 异常。

## 本地方法栈

本地方法栈（Native Method Stack）与虚拟机栈所发挥的作用是非常相似的，它们之间的区别不过是虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则为虚拟机使用到的Native方法服务。与虚拟机栈一样，本地方法栈区域也会抛出StackOverflowError和OutOfMemoryError异常。

## Java 堆

Java 堆是被所有线程共享的一块内存区域，在虚拟机启动时创建。Java堆用来存放对象实例，几乎所有的对象实例都在这里分配内存。Java 堆是垃圾收集器管理的主要区域。

Java 堆可以是固定的，也可以是动态的扩展。Java 堆所使用的内存可以在物理上不连续，只要逻辑上是连续的即可。

Java虚拟机规范中定义了一种异常情况：

* 如果堆中没有足够的内存完成实例分配，并且堆也无法再进行扩展时，将抛出OutOfMemoryError异常。

## 方法区

方法区是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息，包括运行时常量、字段和方法信息、静态变量等数据。方法区是Java堆的逻辑组成部分，它一样在物理上不需要连续，并且可以选择在方法区中不实现垃圾收集。方法区并不等同于永久代，只是因为HotSpot VM使用永久代来实现方法区，对于其他的Java虚拟机，比如J9和JRockit等，并不存在永久代概念。

Java虚拟机规范中定义了一种异常情况：

* 如果方法区的内存空间不满足内存分配需求时，Java虚拟机会抛出OutOfMemoryError异常。

## 运行时常量池

运行时常量池（Runtime Constant Pool）是方法区的一部分，Class文件除了包括类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译期生成的各种字面量和符号引用，这部内容将在类加载后进入方法区的运行时常量池中存放。

Java虚拟机规范中定义了一种异常情况：

* 当创建类或接口时，如果构造运行时常量池所需的内存超过了方法区所能提供的最大值，Java虚拟机会抛出OutOfMemoryError异常

# 参考资料

《深入理解Java虚拟机》

[Java虚拟机（一）结构原理与运行时数据区域](http://liuwangshu.cn/java/jvm/1-runtime-data-area.html)


